# HTTP Load Balancer with Rate Limiting (Go)

## Описание

Этот проект представляет собой HTTP-балансировщик нагрузки, написанный на Go, с интегрированным модулем ограничения скорости (Rate-Limiting) для каждого клиента. Кроме того, реализован CRUD (Create, Read, Update, Delete) для управления клиентами, что упрощает использование и тестирование приложения.  Использована база данных PostgreSQL для хранения информации о клиентах и их лимитах.

## Основной сценарий использования

1.  **Создание клиента (Create Client):**

    *   Используйте эндпоинт `http://localhost:3030/clients` для создания нового клиента.  Передайте данные клиента в формате JSON в теле запроса.

    **Пример запроса (Example Request):**

    ```json
    {
        "client_id": "client9",
        "capacity": 100,
        "rate_per_sec": 5.0,
        "current_tokens": 50
    }
    ```

2.  **Проверка Rate-Limiting :**

    *   Используйте инструмент Apache Bench (`ab`) для создания нагрузки от имени созданного клиента.  Укажите `client_id` в параметрах запроса.

    **Пример команд при 2 созданных клиентах :**

    ```bash
    ab -n 1000 -c 10 "http://localhost:3030/?client_id=client9"
    ab -n 1000 -c 10 "http://localhost:3030/?client_id=client1"
    ```

    *   В результате, только часть запросов будет выполнена в соответствии с настроенными лимитами для клиента.  Остальные запросы будут отклонены с кодом состояния HTTP `429 Too Many Requests`.
   
      ```bash
    Concurrency Level:      10
    Time taken for tests:   1.353 seconds
    Complete requests:      1000
    Failed requests:        894

    Concurrency Level:      10
    Time taken for tests:   1.476 seconds
    Complete requests:      1000
    Failed requests:        893
    ```

3.  **Балансировка нагрузки :**

    *   Если запрос разрешен rate-limiter-ом, он перенаправляется с помощью load-banacer на один из backend-сервисов, определенных в `docker-compose.yml`.
    *   Клиент получает ответ от выбранного backend-сервиса.

    **Пример ответа :**

    ```html
    <html>
    <head>
        <title>HTTP Hello World</title>
    </head>
    <body>
        <h1>Hello from 891c02b885d6</h1>
    </body>
    </html>
    ```
4. **Реализованный функционал :**

   *  Алгоритм распределения запросов по бэкендам (round-robin).
   *  Корректная обработка ситуации, когда один или несколько бэкендов недоступны (выводит сообщение об ошибке "Service not available" или перенаправлять запросы на работающие серверы).
   *  Одновременную обработку нескольких запросов с использованием горутин.
   *  Корректная работа в условиях конкурентных вызовов с помощью sync.Mutex и "sync/atomic".
   *  Логирование на LoadBalancer и TimeLimiter.
   *  Обработка ошибок с помощью *httputil.ReverseProxy - ErrorHandler и http.Error.
   *  Health Checks бэкэндов.
   *  Сохранение состояния клиентов в БД.
   *  CRUD для управления клиентами.
   *  time.Ticker для периодического пополнения токенов, атомарность операций с токенами (RWMutex), потокобезопасные методы запросов и обновления состояния buckets, etc.
     
5. **Сборка и запуск :**
  *  Клонируйте репозиторий.
  *  Выполните ```bash docker-compose up --build```

